<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Link Maker</title>
<style>
  body{margin:0;font-family:system-ui,apple sd gothic neo,Segoe UI,Roboto,Arial,sans-serif;background:#111;color:#eee}
  #app{min-height:100vh;display:grid;place-items:center;padding:24px}
  .card{max-width:720px;width:100%}
</style>
<div id="app">Loading…</div>
<script type="module">
import { qs } from '../lib/utils.js';

const params = new URLSearchParams(location.search);
const card   = qs('card','hanlove');
const listParam = qs('list', null);

// 카드별 1차 기본 리스트
const CARD_DEFAULT = { hanlove: 'default', healing: 'bible30' };
const wantList = listParam || CARD_DEFAULT[card] || 'default';

const REGISTRY = {
  hanlove: { tpl: '/cards/hanlove/template.js', css: '/cards/hanlove/style.css' },
  healing: { tpl: '/cards/healing/template.js', css: '/cards/healing/style.css' },
};

async function loadData(card, list){
  // 1) 사용자가 요청한 리스트
  const wantPath = `/data/${card}/${list}.json`;
  let data = await tryFetch(wantPath);
  if (data) return {data, path: wantPath};

  // 2) 카드의 default.json (ex. healing도 여기로 안전 폴백)
  const defPath = `/data/${card}/default.json`;
  data = await tryFetch(defPath);
  if (data) return {data, path: defPath};

  // 3) 최후 보루: 공용 fallback
  const fbPath = `/fallback.json`;
  data = await tryFetch(fbPath);
  return {data: data || {meta:{},items:[]}, path: fbPath};
}

async function tryFetch(path){
  try{
    const r = await fetch(path, {cache:'no-store'});
    if(!r.ok) throw 0;
    return await r.json();
  }catch{ return null; }
}

async function boot(){
  const app = document.getElementById('app');
  const cfg = REGISTRY[card];
  if(!cfg){ app.textContent = 'Unknown card'; return; }

  // CSS 로드
  const linkEl = document.createElement('link');
  linkEl.rel='stylesheet'; linkEl.href=cfg.css; document.head.appendChild(linkEl);

  // 데이터 로드(요청 리스트 → default.json → fallback.json)
  const {data, path} = await loadData(card, wantList);

  // 템플릿 로드 & 렌더
  const mod = await import(cfg.tpl);
  const view = await mod.render({ data, params });
  app.innerHTML=''; app.appendChild(view);

  // (선택) 콘솔에 실제 로드 경로 표시
  console.info('[LinkMaker] data loaded from:', path);
}
boot();
</script>

</html>
