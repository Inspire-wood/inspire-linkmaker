<!doctype html><meta charset="utf-8"/>
<title>Link Maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--bg:#0b1020;--panel:#121a36;--line:#3a4368;--ink:#fff;--muted:#94a3b8;--accent:#5b77ff}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1140px;margin:24px auto;padding:0 20px}
  .flex{display:grid;grid-template-columns:360px 1fr;gap:16px}
  label{display:block;margin:10px 0 4px;font-size:12px;opacity:.85}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--ink)}
  button{padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  iframe{width:100%;height:560px;background:#0f1530;border:1px solid var(--line);border-radius:12px}
  .row{margin:10px 0}.inline{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  .topbar{display:flex;justify-content:flex-start;align-items:center;margin:10px 0 8px}
  .topbar a.btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--line);
    background:var(--panel);color:var(--ink);text-decoration:none;font-size:13px}
  .topbar a.btn:hover{background:#152049}
  #url,#shortUrl{font-family:ui-monospace,Menlo,Consolas,"SF Mono",monospace;white-space:nowrap;overflow-x:auto}
  .combo{position:relative}
  .dropdown{position:absolute;left:0;right:0;top:100%;z-index:30;max-height:260px;overflow:auto;
    background:#0f1530;border:1px solid var(--line);border-radius:10px;margin-top:6px;display:none}
  .dropdown .item{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer;display:flex;gap:8px;align-items:center}
  .dropdown .item:hover{background:#162048}
  .dropdown .item.active{background:#162048}
  .badge{padding:2px 6px;border-radius:999px;background:#1f2a54;border:1px solid var(--line);font-size:11px;color:#cbd5e1}
  .card{border:1px dashed var(--line);border-radius:12px;padding:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
</style>

<div class="wrap">
  <div class="topbar">
    <a href="/admin/" class="btn">← 운영 대시보드로</a>
  </div>
  <h2>Link Maker</h2>
  <div class="flex">
    <div>
      <label>환경</label>
      <select id="env"></select>

      <label>card</label>
      <select id="card">
        <option value="hanlove">hanlove</option>
        <option value="healing">healing</option>
      </select>

      <label>list</label>
      <input id="list" placeholder="default / bible30 / custom-..." value="default"/>

      <label>mode</label>
      <select id="mode">
        <option>daily</option><option>fixed</option><option selected>shuffle</option>
      </select>

      <label>id (mode=fixed일 때)</label>
      <input id="itemId" placeholder="HL-002"/>

      <label>옵션</label>
      <div class="row">
        <label class="inline"><input type="checkbox" id="showCredit"> showCredit</label>
        <label class="inline"><input type="checkbox" id="utm" checked> UTM 기본값</label>
      </div>

      <label>버전 v=</label>
      <input id="v" placeholder="1" value="1"/>

      <!-- Hanlove 전용 -->
      <div id="hanloveBlock" style="display:none; margin-top:14px">
        <div class="muted" style="margin-bottom:6px">한글사랑 전용 · 저장소 항목 선택 → 발음/영어 자동 입력</div>

        <label>한글 (검색/선택)</label>
        <div class="combo">
          <input id="hanloveSearch" placeholder="예) 고마워, 사랑해, 괜찮아 …" autocomplete="off"/>
          <div id="hanloveDropdown" class="dropdown"></div>
        </div>
        <div id="hanloveCount" class="muted" style="margin:6px 0 10px"></div>

        <label>한국어 발음 (자동)</label>
        <input id="hanlovePron" placeholder="go-ma-wo" disabled />

        <label>영어의미 (저장소)</label>
        <input id="hanloveEn" placeholder="It’s okay" disabled />

        <label style="margin-top:10px">홍보 링크(promo, 선택)</label>
        <input id="promo" placeholder="https://your-landing.example" />
        <div class="muted">카드의 “Open Healing Message” 버튼이 이 주소로 이동합니다.</div>
      </div>

      <div class="row"><button id="build">링크 생성</button></div>
      <div class="row"><input id="url" readonly></div>

      <label style="margin-top:12px">단축 URL</label>
      <div class="row" style="display:flex;gap:8px;align-items:center">
        <input id="slug" placeholder="slug(비우면 자동 생성)" style="max-width:220px"/>
        <button id="mkShort">단축 URL 생성</button>
      </div>
      <div class="row"><input id="shortUrl" readonly placeholder="https://…/s/&lt;slug&gt;"/></div>
      <div class="row">
        <button id="copy">URL 복사</button>
        <button id="copyShort">단축URL 복사</button>
        <button id="dlShort">단축URL 다운로드(.txt)</button>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="grid2">
          <div>
            <label>GitHub Owner</label>
            <input id="gh_owner" placeholder="예: inspire-wood"/>
          </div>
          <div>
            <label>Repo</label>
            <input id="gh_repo" placeholder="예: inspire-linkmaker"/>
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Branch</label>
            <input id="gh_branch" value="main"/>
          </div>
          <div>
            <label>Path to slugs.json</label>
            <input id="gh_path" value="data/slugs.json"/>
          </div>
        </div>
        <label>GitHub Token (repo:contents)</label>
        <input id="gh_token" type="password" placeholder="GitHub Personal Access Token (fine-grained 권장)"/>
        <div class="row inline">
          <button id="btnPublish">슬러그 발행(GitHub 저장)</button>
          <label class="inline" style="gap:6px">
            <input type="checkbox" id="rememberRepo"/> owner/repo/branch 기억
          </label>
        </div>
        <div id="pubStatus" class="muted"></div>
      </div>

    </div>

    <div>
      <iframe id="preview" title="preview"></iframe>
    </div>
  </div>
</div>

<script>
async function loadConfig(){ const r=await fetch('/admin/config.json',{cache:'no-store'}); return r.json(); }
function buildURL(base){
  const p = new URL(base.replace(/\\/$/,'') + '/link');
  const card = document.getElementById('card').value;
  const list = (document.getElementById('list').value || 'default').trim() || 'default';
  const mode = document.getElementById('mode').value;
  const id   = document.getElementById('itemId').value.trim();
  const v    = document.getElementById('v').value.trim();
  p.searchParams.set('card', card);
  p.searchParams.set('list', list);
  p.searchParams.set('mode', mode);
  if(mode==='fixed' && id) p.searchParams.set('id', id);
  if(card==='hanlove'){
    const promo=(document.getElementById('promo').value||'').trim();
    if(promo) p.searchParams.set('promo', promo);
  }
  if(document.getElementById('showCredit').checked) p.searchParams.set('showCredit','true');
  if(v) p.searchParams.set('v', v);
  if(document.getElementById('utm').checked){
    p.searchParams.set('utm_source','qr');
    p.searchParams.set('utm_campaign', card);
    p.searchParams.set('utm_content', list);
  }
  return p.toString();
}

/* ===== Hanlove 데이터/콤보 ===== */
const $ = (q)=>document.querySelector(q);
const elCard=$('#card'), elList=$('#list'), elMode=$('#mode'), elId=$('#itemId');
const block=$('#hanloveBlock'), search=$('#hanloveSearch'), box=$('#hanloveDropdown');
const inPron=$('#hanlovePron'), inEn=$('#hanloveEn'), countEl=$('#hanloveCount');

let HANLOVE_CACHE={ listKey:null, items:[] };

function romanizeKo(str=''){
  const BASE=0xAC00, CHO=["g","kk","n","d","tt","r","m","b","pp","s","ss","","j","jj","ch","k","t","p","h"];
  const JUNG=["a","ae","ya","yae","eo","e","yeo","ye","o","wa","we","oe","yo","u","wo","we","wi","yu","eu","ui","i"];
  const JONG=["","k","k","ks","n","nj","nh","t","l","lk","lm","lb","ls","lt","lp","lt","m","p","ps","t","t","ng","t","t","k","t","p","t"];
  const out=[]; for(const ch of str){ const c=ch.charCodeAt(0);
    if(c<0xAC00||c>0xD7A3){ out.push(ch); continue }
    const s=c-BASE, cho=Math.floor(s/588), jung=Math.floor((s%588)/28), jong=s%28;
    out.push((CHO[cho]||'')+(JUNG[jung]||'')+(JONG[jong]||'')); }
  return out.join('-').replace(/-+/g,'-');
}
async function tryFetch(path){ try{ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }catch{ return null } }
async function loadHanloveData(listName){
  const list=(listName||'default').trim()||'default';
  const want=await tryFetch(`/data/hanlove/${list}.json`);
  const def = want || await tryFetch('/data/hanlove/default.json');
  const items=(def?.items||[]).filter(x=>(x.status||'APPROVED')==='APPROVED' && x.text);
  return { listKey:list, items: items.map(x=>({id:x.id||'',text:(x.text||'').trim(),en:(x.en||'').trim(),pron:(x.pron||'')})) };
}
function showHanlove(on){ block.style.display=on?'block':'none'; if(!on) box.style.display='none' }
let selIndex=-1;
function setActiveByIndex(i){
  const items=[...box.querySelectorAll('.item')];
  items.forEach((n,idx)=>n.classList.toggle('active', idx===i));
  if(i>=0 && items[i]) items[i].scrollIntoView({block:'nearest'});
}
function renderDropdown(items, keyword=''){
  box.innerHTML='';
  const lc=keyword.trim().toLowerCase();
  const filtered=items.filter(it=>{
    if(!lc) return true;
    return it.text.toLowerCase().includes(lc)||it.en.toLowerCase().includes(lc)||it.id.toLowerCase().includes(lc);
  }).slice(0,200);
  filtered.forEach(it=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<span>${it.text}${it.en?` · ${it.en}`:''}</span><span class="badge">${it.id}</span>`;
    row.onclick=()=>applySelection(it);
    row.addEventListener('mouseenter', ()=>{ selIndex=filtered.indexOf(it); setActiveByIndex(selIndex); });
    box.appendChild(row);
  });
  selIndex=-1;
  countEl.textContent=`총 ${items.length}개 · 필터 ${filtered.length}개`;
  box.style.display=filtered.length?'block':'none';
}
function applySelection(it){
  search.value=it.text;
  inPron.value=it.pron||romanizeKo(it.text);
  inEn.value=it.en||'';
  elId.value=it.id||'';
  if(elMode.value!=='fixed') elMode.value='fixed';
  box.style.display='none';
  document.getElementById('build').click();
}
async function refreshHanloveBlock(){
  const isHL=elCard.value==='hanlove';
  showHanlove(isHL); if(!isHL) return;
  const listKey=(elList.value||'default').trim()||'default';
  if(HANLOVE_CACHE.listKey!==listKey){ HANLOVE_CACHE=await loadHanloveData(listKey); }
  search.value=''; inPron.value=''; inEn.value=''; elId.value='';
  renderDropdown(HANLOVE_CACHE.items,'');
}

/* ===== 부트스트랩 & 자동 갱신 ===== */
function wireAutoRebuild(rebuild){
  const ids=['env','card','list','mode','itemId','showCredit','utm','v','promo'];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    const evt=(el.tagName==='INPUT' && el.type==='text')?'input':'change';
    el.addEventListener(evt, rebuild);
  });
}

async function boot(){
  const cfg=await loadConfig();
  const envSel=document.getElementById('env');
  for(const k of Object.keys(cfg.envs)){ const o=document.createElement('option'); o.value=k; o.textContent=k; envSel.appendChild(o); }
  envSel.value=cfg.default_env||'staging';

  const rebuild=()=>{
    const base=cfg.envs[envSel.value].base;
    const url=buildURL(base);
    document.getElementById('url').value=url;
    document.getElementById('preview').src=url;
  };
  document.getElementById('build').onclick=rebuild;
  document.getElementById('copy').onclick=async()=>{ await navigator.clipboard.writeText(document.getElementById('url').value); alert('복사됨'); };
  wireAutoRebuild(rebuild);

  // Hanlove 이벤트
  elCard.addEventListener('change', refreshHanloveBlock);
  elList.addEventListener('change', refreshHanloveBlock);
  const block = document.getElementById('hanloveBlock'), box=document.getElementById('hanloveDropdown'), search=document.getElementById('hanloveSearch');
  document.addEventListener('click', (e)=>{ if(!block.contains(e.target)) box.style.display='none'; });
  search.addEventListener('input', ()=>renderDropdown(HANLOVE_CACHE.items, search.value));
  search.addEventListener('focus', ()=>renderDropdown(HANLOVE_CACHE.items, search.value));
  search.addEventListener('keydown', (e)=>{
    const items=[...box.querySelectorAll('.item')];
    if(e.key==='ArrowDown' && items.length){ e.preventDefault(); selIndex=(selIndex+1)%items.length; setActiveByIndex(selIndex); }
    else if(e.key==='ArrowUp' && items.length){ e.preventDefault(); selIndex=(selIndex<=0?items.length:selIndex)-1; setActiveByIndex(selIndex); }
    else if(e.key==='Enter'){ e.preventDefault(); if(!items.length) return; if(selIndex<0) selIndex=0; items[selIndex].click(); }
    else if(e.key==='Escape'){ box.style.display='none'; }
  });

  // Short URL 바인딩
  function fileSafe(name='link'){ return (name||'link').replace(/[\\/:*?"<>|]+/g,'-').replace(/\\s+/g,' ').trim().slice(0,60); }
  function slugify(s='link'){ return s.toLowerCase().normalize('NFKD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,32)||'link'; }
  const getEnglishMeaning=()=> (document.getElementById('hanloveEn')?.value||'').trim();

  function makeShort(){
    const base=cfg.envs[envSel.value].base.replace(/\\/$/,'');
    const slugEl=document.getElementById('slug');
    let slug=(slugEl.value||'').trim();
    if(!slug){ slug=slugify(getEnglishMeaning()||document.getElementById('itemId').value||'link'); slugEl.value=slug; }
    document.getElementById('shortUrl').value=`${base}/s/${slug}`;
  }
  function downloadShortTxt(){
    const short=document.getElementById('shortUrl').value.trim();
    if(!short){ alert('먼저 단축 URL을 생성하세요.'); return; }
    const fname=fileSafe(getEnglishMeaning()||'link')+'.txt';
    const blob=new Blob([short],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  }
  document.getElementById('mkShort').onclick=makeShort;
  document.getElementById('copyShort').onclick=async()=>{ const v=document.getElementById('shortUrl').value; if(!v){ alert('먼저 단축 URL을 생성하세요.'); return; } await navigator.clipboard.writeText(v); alert('단축URL 복사됨'); };
  document.getElementById('dlShort').onclick=downloadShortTxt;

  // ===== 슬러그 발행 (GitHub 커밋) =====
  const $id=(x)=>document.getElementById(x);
  const saved = JSON.parse(localStorage.getItem('lm_repo')||'{}');
  if(saved.owner) $id('gh_owner').value=saved.owner;
  if(saved.repo)  $id('gh_repo').value=saved.repo;
  if(saved.branch)$id('gh_branch').value=saved.branch;

  async function githubGetJSON({owner,repo,branch,path,token}){
    const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const res=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':token?`Bearer ${token}`:''}});
    if(res.status===404){ return {json:{}, sha:null}; }
    if(!res.ok){ const t=await res.text(); throw new Error(`GET ${res.status}: ${t}`); }
    const data=await res.json();
    const content=atob(data.content.replace(/\\n/g,''));
    return {json: JSON.parse(content||'{}'), sha:data.sha};
  }
  async function githubPutJSON({owner,repo,branch,path,token,json,sha,message}){
    const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body={ message, branch, content:btoa(unescape(encodeURIComponent(JSON.stringify(json,null,2)))), sha:sha||undefined };
    const res=await fetch(url,{method:'PUT', headers:{'Accept':'application/vnd.github+json','Authorization':token?`Bearer ${token}`:'', 'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!res.ok){ const t=await res.text(); throw new Error(`PUT ${res.status}: ${t}`); }
    return await res.json();
  }
  function status(msg,type='info'){
    const el=$id('pubStatus');
    el.textContent=msg;
    el.style.color = type==='error' ? '#ff7b7b' : (type==='ok' ? '#9ae6b4' : '#94a3b8');
  }

  $id('btnPublish').onclick = async ()=>{
    try{
      const owner=$id('gh_owner').value.trim();
      const repo=$id('gh_repo').value.trim();
      const branch=$id('gh_branch').value.trim()||'main';
      const path=$id('gh_path').value.trim()||'data/slugs.json';
      const token=$id('gh_token').value.trim();
      if(!owner||!repo){ alert('owner/repo를 입력하세요.'); return; }
      if(!token){ alert('GitHub Token이 필요합니다.'); return; }

      if(!$id('shortUrl').value) document.getElementById('mkShort').click();
      const short = $id('shortUrl').value.trim();
      if(!short){ alert('먼저 단축 URL을 생성하세요.'); return; }

      const slug = ($id('slug').value||'').trim();
      const linkUrl = new URL($id('url').value);
      const finalPath = linkUrl.pathname + linkUrl.search; // /link?... (호스트 제외)

      status('GitHub에서 slugs.json 불러오는 중…');
      const {json,sha} = await githubGetJSON({owner,repo,branch,path,token});
      json[slug] = { path: finalPath, note: getEnglishMeaning() || '', updatedAt: new Date().toISOString() };

      status('슬러그 저장 중(커밋)…');
      await githubPutJSON({owner,repo,branch,path,token,json,sha,message:`chore(slug): publish ${slug} -> ${finalPath}`});

      if($id('rememberRepo').checked){
        localStorage.setItem('lm_repo', JSON.stringify({owner,repo,branch}));
      }
      status('완료! slugs.json 커밋됨. Pages가 곧 반영합니다.', 'ok');
      alert('슬러그 발행 완료!\\n➡ ' + short + '\\n(잠시 후 접속 확인하세요)');
    }catch(err){
      console.error(err);
      status('에러: '+ err.message, 'error');
      alert('발행 실패\\n\\n'+ err.message);
    }
  };

  await refreshHanloveBlock();
  rebuild();
}
boot();
</script>
