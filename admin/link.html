<!doctype html><meta charset="utf-8"/>
<title>Link Maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--bg:#0b1020;--panel:#121a36;--line:#3a4368;--ink:#fff;--muted:#94a3b8;--accent:#5b77ff}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1080px;margin:24px auto;padding:0 20px}
  .flex{display:grid;grid-template-columns:320px 1fr;gap:16px}
  label{display:block;margin:10px 0 4px;font-size:12px;opacity:.85}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--ink)}
  button{padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  iframe{width:100%;height:520px;background:#0f1530;border:1px solid var(--line);border-radius:12px}
  .row{margin:10px 0}.inline{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:12px}.qr{margin-top:10px}
  /* 검색 콤보 */
  .combo{position:relative}
  .dropdown{position:absolute;left:0;right:0;top:100%;z-index:30;max-height:260px;overflow:auto;
    background:#0f1530;border:1px solid var(--line);border-radius:10px;margin-top:6px;display:none}
  .dropdown .item{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer;display:flex;gap:8px;align-items:center}
  .dropdown .item:hover{background:#162048}
  .badge{padding:2px 6px;border-radius:999px;background:#1f2a54;border:1px solid var(--line);font-size:11px;color:#cbd5e1}
</style>

<div class="wrap">
  <h2>Link Maker</h2>
  <div class="flex">
    <div>
      <label>환경</label>
      <select id="env"></select>

      <label>card</label>
      <select id="card">
        <option value="hanlove">hanlove</option>
        <option value="healing">healing</option>
      </select>

      <label>list</label>
      <input id="list" placeholder="default / bible30 / custom-..." value="default"/>

      <label>mode</label>
      <select id="mode">
        <option>daily</option><option>fixed</option><option selected>shuffle</option>
      </select>

      <label>id (mode=fixed일 때)</label>
      <input id="itemId" placeholder="HL-002"/>

      <label>옵션</label>
      <div class="row">
        <label class="inline"><input type="checkbox" id="showCredit"> showCredit</label>
        <label class="inline"><input type="checkbox" id="utm" checked> UTM 기본값</label>
      </div>

      <label>버전 v=</label>
      <input id="v" placeholder="1" value="1"/>

      <!-- ───── Hanlove 전용 ───── -->
      <div id="hanloveBlock" style="display:none; margin-top:14px">
        <div class="muted" style="margin-bottom:6px">한글사랑 전용 · 저장소 항목 선택 → 발음/영어 자동 입력</div>

        <label>한글 (검색/선택)</label>
        <div class="combo">
          <input id="hanloveSearch" placeholder="예) 고마워, 사랑해, 괜찮아 …" autocomplete="off"/>
          <div id="hanloveDropdown" class="dropdown"></div>
        </div>
        <div id="hanloveCount" class="muted" style="margin:6px 0 10px"></div>

        <label>한국어 발음 (자동)</label>
        <input id="hanlovePron" placeholder="go-ma-wo" disabled />

        <label>영어의미 (저장소)</label>
        <input id="hanloveEn" placeholder="It’s okay" disabled />

        <div class="muted" style="margin-top:8px">
          항목을 선택하면 왼쪽의 <b>mode</b>가 <code>fixed</code>로, <b>id</b>가 자동 입력됩니다.
        </div>

        <label style="margin-top:10px">홍보 링크(promo, 선택)</label>
        <input id="promo" placeholder="https://your-landing.example" />
        <div class="muted">카드의 “Open Healing Message” 버튼이 이 주소로 이동합니다.</div>
      </div>
      <!-- ─────────────────────── -->

      <div class="row"><button id="build">링크 생성</button></div>
      <div class="row"><input id="url" readonly></div>
      <div class="row"><button id="copy">URL 복사</button> <button id="makeQR">QR 생성</button></div>
      <div id="qrcode" class="qr"></div>
    </div>

    <div>
      <iframe id="preview" title="preview"></iframe>
    </div>
  </div>
</div>

<script>
/* ===== 공통 ===== */
async function loadConfig(){ const r=await fetch('/admin/config.json',{cache:'no-store'}); return r.json(); }
function buildURL(base){
  const p = new URL(base.replace(/\/$/,'') + '/link');
  const card = document.getElementById('card').value;
  const list = (document.getElementById('list').value || 'default').trim() || 'default';
  const mode = document.getElementById('mode').value;
  const id   = document.getElementById('itemId').value.trim();
  const v    = document.getElementById('v').value.trim();
  p.searchParams.set('card', card);
  p.searchParams.set('list', list);
  p.searchParams.set('mode', mode);
  if(mode==='fixed' && id) p.searchParams.set('id', id);
  if(card==='hanlove'){ // promo(선택)
    const promo=(document.getElementById('promo').value||'').trim();
    if(promo) p.searchParams.set('promo', promo);
  }
  if(document.getElementById('showCredit').checked) p.searchParams.set('showCredit','true');
  if(v) p.searchParams.set('v', v);
  if(document.getElementById('utm').checked){
    p.searchParams.set('utm_source','qr');
    p.searchParams.set('utm_campaign', card);
    p.searchParams.set('utm_content', list);
  }
  return p.toString();
}

/* ===== 한글사랑 데이터/콤보 ===== */
const $ = (q)=>document.querySelector(q);
const elCard=$('#card'), elList=$('#list'), elMode=$('#mode'), elId=$('#itemId');
const block=$('#hanloveBlock'), search=$('#hanloveSearch'), box=$('#hanloveDropdown');
const inPron=$('#hanlovePron'), inEn=$('#hanloveEn'), countEl=$('#hanloveCount');

let HANLOVE_CACHE={ listKey:null, items:[] }; // {id,text,en,pron?}

function romanizeKo(str=''){
  const BASE=0xAC00, CHO=["g","kk","n","d","tt","r","m","b","pp","s","ss","","j","jj","ch","k","t","p","h"];
  const JUNG=["a","ae","ya","yae","eo","e","yeo","ye","o","wa","we","oe","yo","u","wo","we","wi","yu","eu","ui","i"];
  const JONG=["","k","k","ks","n","nj","nh","t","l","lk","lm","lb","ls","lt","lp","lt","m","p","ps","t","t","ng","t","t","k","t","p","t"];
  const out=[]; for(const ch of str){ const c=ch.charCodeAt(0);
    if(c<0xAC00||c>0xD7A3){ out.push(ch); continue }
    const s=c-BASE, cho=Math.floor(s/588), jung=Math.floor((s%588)/28), jong=s%28;
    out.push((CHO[cho]||'')+(JUNG[jung]||'')+(JONG[jong]||'')); }
  return out.join('-').replace(/-+/g,'-');
}
async function tryFetch(path){
  try{ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }catch{ return null }
}
async function loadHanloveData(listName){
  const list=(listName||'default').trim()||'default';
  const want=await tryFetch(`/data/hanlove/${list}.json`);
  const def = want || await tryFetch('/data/hanlove/default.json');
  const items=(def?.items||[]).filter(x=>(x.status||'APPROVED')==='APPROVED' && x.text);
  return { listKey:list, items: items.map(x=>({id:x.id||'',text:(x.text||'').trim(),en:(x.en||'').trim(),pron:(x.pron||'')})) };
}
function showHanlove(on){ block.style.display=on?'block':'none'; if(!on) box.style.display='none' }
function renderDropdown(items, keyword=''){
  box.innerHTML='';
  const lc=keyword.trim().toLowerCase();
  const filtered=items.filter(it=>{
    if(!lc) return true;
    return it.text.toLowerCase().includes(lc)||it.en.toLowerCase().includes(lc)||it.id.toLowerCase().includes(lc);
  }).slice(0,200);
  filtered.forEach(it=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<span>${it.text}${it.en?` · ${it.en}`:''}</span><span class="badge">${it.id}</span>`;
    row.onclick=()=>applySelection(it);
    box.appendChild(row);
  });
  countEl.textContent=`총 ${items.length}개 · 필터 ${filtered.length}개`;
  box.style.display=filtered.length?'block':'none';
}
function applySelection(it){
  search.value=it.text;
  inPron.value=it.pron||romanizeKo(it.text);
  inEn.value=it.en||'';
  elId.value=it.id||'';
  if(elMode.value!=='fixed') elMode.value='fixed';
  box.style.display='none';
  document.getElementById('build').click(); // 즉시 프리뷰 갱신
}
async function refreshHanloveBlock(){
  const isHL=elCard.value==='hanlove';
  showHanlove(isHL); if(!isHL) return;
  const listKey=(elList.value||'default').trim()||'default';
  if(HANLOVE_CACHE.listKey!==listKey){ HANLOVE_CACHE=await loadHanloveData(listKey); }
  search.value=''; inPron.value=''; inEn.value=''; elId.value='';
  renderDropdown(HANLOVE_CACHE.items,'');
}

/* ===== 부트스트랩 & 기본 동작 ===== */
async function boot(){
  // config 로드 → 환경 셀렉트 구성
  const cfg=await loadConfig();
  const envSel=document.getElementById('env');
  for(const k of Object.keys(cfg.envs)){ const o=document.createElement('option'); o.value=k; o.textContent=k; envSel.appendChild(o); }
  envSel.value=cfg.default_env||'staging';

  const rebuild=()=>{
    const base=cfg.envs[envSel.value].base;
    const url=buildURL(base);
    document.getElementById('url').value=url;
    document.getElementById('preview').src=url;
  };
  document.getElementById('build').onclick=rebuild;
  document.getElementById('copy').onclick=async()=>{ await navigator.clipboard.writeText(document.getElementById('url').value); alert('복사됨'); };
  document.getElementById('makeQR').onclick=()=>{
    const url=document.getElementById('url').value;
    const img=new Image();
    img.src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(url);
    const q=document.getElementById('qrcode'); q.innerHTML=''; q.appendChild(img);
  };

  // Hanlove 이벤트
  elCard.addEventListener('change', refreshHanloveBlock);
  elList.addEventListener('change', refreshHanloveBlock);
  search.addEventListener('input', ()=>renderDropdown(HANLOVE_CACHE.items, search.value));
  search.addEventListener('focus', ()=>renderDropdown(HANLOVE_CACHE.items, search.value));
  document.addEventListener('click', (e)=>{ if(!block.contains(e.target)) box.style.display='none'; });

  // 초기 표시
  await refreshHanloveBlock();
  rebuild();
}
boot();
  // ① 모든 폼 요소 변경 시 자동 리빌드
function wireAutoRebuild(rebuild){
  const ids = ['env','card','list','mode','itemId','showCredit','utm','v','promo'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const evt = (el.tagName==='INPUT' && el.type==='text') ? 'input' : 'change';
    el.addEventListener(evt, rebuild);
  });
}

// boot() 안, rebuild 정의된 뒤 바로 아래 한 줄 추가
wireAutoRebuild(rebuild);
</script>
