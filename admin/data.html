<!doctype html><meta charset="utf-8"/>
<title>Data Editor · Link Maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--bg:#0b1020;--card:#121a36;--line:#3a4368;--fg:#fff;--muted:#94a3b8}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 20px}
  h2{margin:0 0 10px}
  .bar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px;flex-wrap:wrap}
  .tab{background:var(--card);border:1px solid var(--line);padding:8px 12px;border-radius:12px;cursor:pointer}
  .tab.active{outline:2px solid #5b77ff}
  .pill{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  input,select,button,textarea{border-radius:12px;border:1px solid var(--line);background:#0f1530;color:#fff}
  input,select,textarea{padding:10px}
  button{padding:10px 14px;background:#5b77ff;border:0;cursor:pointer}
  .btn{padding:10px 14px}
  .btn.ghost{background:transparent;border:1px dashed var(--line)}
  .btn.small{font-size:12px;padding:6px 8px}
  .btn.danger{background:#ff5b5b}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
  th{font-weight:600;text-align:left}
  td input,td select,td textarea{width:100%}
  .right{margin-left:auto}
  .muted{color:var(--muted);font-size:12px}
  .status{padding:6px 10px;border-radius:10px;background:#0f1530;border:1px solid var(--line)}
  .grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
</style>

<div class="wrap">
  <div class="bar">
    <a href="/admin/" class="btn ghost">← 운영 대시보드로</a>
    <h2 style="margin:0">저장소 편집기</h2>
    <span class="pill">/data/&lt;card&gt;/&lt;list&gt;.json</span>
    <span class="right muted" id="repoInfo"></span>
  </div>

  <!-- 1) 카드 탭 -->
  <div class="tabs" id="cardTabs">
    <div class="tab active" data-card="hanlove">한글사랑</div>
    <div class="tab" data-card="healing">힐링메세지</div>
  </div>

  <!-- 2) 그룹(리스트) 탭 + 프리셋 -->
  <div class="card">
    <div class="grid">
      <div><b>그룹(리스트)</b> <span class="muted">엑셀 시트처럼 탭 전환</span></div>
      <div class="right">
        <input id="newListName" placeholder="새 그룹 이름(예: default, bible30, poem)"/>
        <button class="btn small" id="addListBtn">+ 그룹 추가</button>
        <button class="btn small ghost" id="refreshListsBtn">목록 새로고침</button>
      </div>
    </div>
    <div class="tabs" id="listTabs"></div>

    <div class="row" id="presetBox" style="display:none">
      <span class="muted">힐링 프리셋:</span>
      <button class="btn small ghost" data-preset="A">A) 힐링메세지</button>
      <button class="btn small ghost" data-preset="B">B) 성구30</button>
      <button class="btn small ghost" data-preset="C">C) 시(詩)</button>
      <span class="muted">→ 클릭하면 템플릿으로 새 그룹이 만들어집니다.</span>
    </div>
    <div class="muted">※ v0은 JSON을 파일로 저장(다운로드) 또는 GitHub 커밋(선택)으로 생성/갱신합니다.</div>
  </div>

  <!-- 3) 에디터 헤더 -->
  <div class="row">
    <div class="status" id="pathBadge">/data/hanlove/default.json</div>
    <button class="btn small ghost" id="reloadBtn">불러오기</button>
  </div>

  <!-- 4) 표 에디터 -->
  <div class="card">
    <div id="editorHeader"></div>
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
    <div class="row">
      <button id="addRowBtn">+ 항목 추가</button>
      <div class="right"></div>
      <button id="downloadBtn">JSON 다운로드</button>
      <button id="commitBtn" class="btn ghost">GitHub 커밋(선택)</button>
    </div>
  </div>

  <!-- 5) GitHub 커밋(옵션) -->
  <div class="card" id="ghBox" style="display:none">
    <div class="grid">
      <div><b>GitHub 저장 (선택)</b><div class="muted">토큰은 브라우저 메모리에만 임시 사용·저장 안 함</div></div>
    </div>
    <div class="row">
      <input id="ghOwner" placeholder="owner" value="Inspire-wood">
      <input id="ghRepo"  placeholder="repo"  value="inspire-linkmaker">
      <input id="ghBranch" placeholder="branch" value="main">
      <input id="ghToken" placeholder="Personal Access Token (Optional for listing/commit)" type="password">
    </div>
    <div class="row">
      <button id="doCommitBtn">이 파일 커밋</button>
      <span class="muted">→ 새 파일 생성 또는 업데이트</span>
    </div>
    <div class="row"><div id="ghMsg" class="muted"></div></div>
  </div>
</div>

<script>
/* ----------------------- 설정 (필요 시 수정) ----------------------- */
let GITHUB_OWNER  = 'Inspire-wood';
let GITHUB_REPO   = 'inspire-linkmaker';
let GITHUB_BRANCH = 'main';
document.getElementById('repoInfo').textContent = `${GITHUB_OWNER}/${GITHUB_REPO}@${GITHUB_BRANCH}`;

/* ------------------------- 상태 ------------------------- */
const state = {
  card: 'hanlove',
  lists: { hanlove: ['default'], healing: [] },
  list: 'default',
  data: { meta:{}, items:[] }
};

const $  = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);

/* ------------------------- GitHub API ------------------------- */
async function ghListJsonFiles(card){
  const token = $('#ghToken')?.value?.trim();
  const headers = token ? { 'Authorization': `token ${token}` } : {};
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/data/${encodeURIComponent(card)}?ref=${encodeURIComponent(GITHUB_BRANCH)}`;
  try{
    const r = await fetch(url, { headers });
    if(!r.ok) throw new Error('list fail');
    const arr = await r.json();
    const lists = arr.filter(x=>x.type==='file' && x.name.endsWith('.json'))
                     .map(x=>x.name.replace(/\.json$/,''));
    // 알파벳/숫자순 정렬, default 가장 앞으로
    lists.sort((a,b)=>a.localeCompare(b,'en'));
    const i = lists.indexOf('default'); if(i>0){ lists.splice(i,1); lists.unshift('default'); }
    return lists;
  }catch(e){
    return null;
  }
}

/* ------------------------- 유틸 ------------------------- */
function pathFor(card=listState().card, list=listState().list){
  return `/data/${card}/${list}.json`;
}
function listState(){ return { card: state.card, list: state.list }; }
async function fetchJSON(p){
  try{
    const r = await fetch(p, {cache:'no-store'});
    if(!r.ok) throw new Error('404');
    return await r.json();
  }catch(e){ return null; }
}
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

/* ------------------ 로마자 표기(업그레이드) ------------------ */
/* Revised Romanization + 간단한 음가 반영(받침 k/t/p/ng, ㄹ r/l, ㅙ=we 등) */
function romanizeKoPro(str=''){
  const BASE=0xAC00;
  const CHO_INIT = ["g","kk","n","d","tt","r","m","b","pp","s","ss","","j","jj","ch","k","t","p","h"];
  const JUNG = ["a","ae","ya","yae","eo","e","yeo","ye","o","wa","wae","oe","yo","u","wo","we","wi","yu","eu","ui","i"];
  // 사용자 선호 반영: ㅙ(index 10) → we
  JUNG[10] = "we";
  const JONG = ["", "k","k","ks","n","nj","nh","t","l","lk","lm","lb","ls","lt","lp","lt","m","p","ps","t","t","ng","t","t","k","t","p","t"];

  const syls = [];
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code < 0xAC00 || code > 0xD7A3){ syls.push(ch); continue; }
    const S = code - BASE;
    const cho  = Math.floor(S/588);
    const jung = Math.floor((S%588)/28);
    const jong = S%28;

    let lead = CHO_INIT[cho] || "";
    // 초성 ㄹ은 r, 종성·중간연결 ㄹ은 l이 자연스러움
    if(lead==='r') lead = 'r';
    if(lead==='') lead = ''; // ㅇ 무음

    let mid  = JUNG[jung] || "";
    let tail = JONG[jong] || "";

    syls.push(lead + mid + tail);
  }
  return syls.join('-').replace(/-+/g,'-');
}

/* ------------------------- UI ------------------------- */
function renderCardTabs(){
  $('#cardTabs').innerHTML = `
    <div class="tab ${state.card==='hanlove'?'active':''}" data-card="hanlove">한글사랑</div>
    <div class="tab ${state.card==='healing'?'active':''}" data-card="healing">힐링메세지</div>
  `;
  $$('#cardTabs .tab').forEach(el=>{
    el.onclick = async ()=>{
      state.card = el.dataset.card;
      // 카드 전환 시 lists 자동 로드
      await refreshLists();
      state.list = state.lists[state.card][0] || 'default';
      togglePresetBox();
      syncPath(); renderListTabs(); loadCurrent();
    };
  });
}
function togglePresetBox(){
  $('#presetBox').style.display = (state.card==='healing') ? 'block' : 'none';
}

function renderListTabs(){
  const lists = state.lists[state.card] || [];
  $('#listTabs').innerHTML = lists.map(x=>`<div class="tab ${state.list===x?'active':''}" data-list="${x}">${x}</div>`).join('');
  $$('#listTabs .tab').forEach(el=>{
    el.onclick = ()=>{ state.list = el.dataset.list; syncPath(); loadCurrent(); };
  });
}
function syncPath(){ $('#pathBadge').textContent = pathFor(); }

/* 테이블 헤더 */
function renderHeader(){
  const thead = $('#tbl thead');
  if(state.card==='hanlove'){
    thead.innerHTML = `
      <tr>
        <th style="width:90px">ID</th>
        <th>한글</th>
        <th>한국어 발음(영문)</th>
        <th>영어 의미</th>
        <th style="width:70px">가중</th>
        <th style="width:100px">상태</th>
        <th style="width:60px"></th>
      </tr>`;
    $('#editorHeader').innerHTML = `<b>한글사랑</b> · <span class="muted">한글 입력 시 발음(영문) 자동 제안 — 예: 괜찮아 → gwen-cha-na</span>`;
  }else{
    thead.innerHTML = `
      <tr>
        <th style="width:90px">ID</th>
        <th>텍스트</th>
        <th>태그(쉼표)</th>
        <th style="width:70px">가중</th>
        <th style="width:100px">상태</th>
        <th style="width:60px"></th>
      </tr>`;
    $('#editorHeader').innerHTML = `<b>힐링메세지</b> · <span class="muted">그룹(리스트)별 관리 · A/B/C 프리셋으로 빠르게 시작</span>`;
  }
}

/* 테이블 바디 */
function renderRows(){
  const tb = $('#tbl tbody'); tb.innerHTML = '';
  const items = state.data.items || [];
  items.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    const common = `<td><input value="${it.id||''}" data-k="id"></td>`;
    if(state.card==='hanlove'){
      tr.innerHTML = common + `
        <td><input value="${it.text||''}" data-k="text" placeholder="예) 괜찮아"></td>
        <td><input value="${it.pron||''}" data-k="pron" placeholder="예) gwen-cha-na"></td>
        <td><input value="${it.en||''}" data-k="en" placeholder="예) It's Okay"></td>
        <td><input value="${it.weight||1}" data-k="weight" type="number" min="1"></td>
        <td>
          <select data-k="status">
            <option ${it.status==='APPROVED'?'selected':''}>APPROVED</option>
            <option ${it.status==='DRAFT'?'selected':''}>DRAFT</option>
          </select>
        </td>
        <td><button class="btn small danger" data-del="${idx}">삭제</button></td>`;
    }else{
      tr.innerHTML = common + `
        <td><textarea rows="2" data-k="text" placeholder="예) 당신의 오늘이 따뜻하길">${it.text||''}</textarea></td>
        <td><input value="${(it.tags||[]).join(',')}" data-k="tags" placeholder="예) 위로,성경"></td>
        <td><input value="${it.weight||1}" data-k="weight" type="number" min="1"></td>
        <td>
          <select data-k="status">
            <option ${it.status==='APPROVED'?'selected':''}>APPROVED</option>
            <option ${it.status==='DRAFT'?'selected':''}>DRAFT</option>
          </select>
        </td>
        <td><button class="btn small danger" data-del="${idx}">삭제</button></td>`;
    }
    tb.appendChild(tr);
  });

  tb.querySelectorAll('input,select,textarea').forEach(el=>{
    el.oninput = ()=>{
      const tr = el.closest('tr');
      const idx = Array.from(tb.children).indexOf(tr);
      const k = el.dataset.k;
      let v = el.value;
      if(k==='weight') v = Number(v)||1;
      if(k==='tags') v = v.split(',').map(s=>s.trim()).filter(Boolean);
      state.data.items[idx][k] = v;
    };
  });
  tb.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{ const i = Number(btn.dataset.del); state.data.items.splice(i,1); renderRows(); };
  });
}

/* ------------------------- 스켈레톤/도우미 ------------------------- */
function skeleton(card){
  if(card==='hanlove'){
    return { meta:{ list: state.list, lang:'ko', credit:'폰트: 무료 상업용' }, items:[
      {id:newId('HL'), text:'', pron:'', en:'', weight:1, status:'DRAFT'}
    ]};
  }
  return { meta:{ list: state.list, lang:'ko', credit:'자료 출처 표기' }, items:[
    {id:newId('HLG'), text:'', tags:[], weight:1, status:'DRAFT'}
  ]};
}
function newId(prefix){ const n = Math.floor(Math.random()*900+100); return `${prefix}-${n}`; }
function addRow(){
  if(state.card==='hanlove') state.data.items.push({id:newId('HL'), text:'', pron:'', en:'', weight:1, status:'DRAFT'});
  else state.data.items.push({id:newId('HLG'), text:'', tags:[], weight:1, status:'DRAFT'});
  renderRows();
}

/* 한글 입력 → 발음 자동 제안 */
document.addEventListener('input',(e)=>{
  const el=e.target;
  if(state.card!=='hanlove') return;
  if(el && el.dataset && el.dataset.k==='text'){
    const tr = el.closest('tr');
    const idx = Array.from($('#tbl tbody').children).indexOf(tr);
    const pron = romanizeKoPro(el.value);
    if(!state.data.items[idx].pron || state.data.items[idx].pron.trim()===''){
      state.data.items[idx].pron = pron;
      tr.querySelector('input[data-k="pron"]').value = pron;
    }
  }
});

/* ------------------------- 불러오기/저장 ------------------------- */
async function loadCurrent(){
  renderHeader();
  const p = pathFor();
  const j = await fetchJSON(p);
  state.data = j || skeleton(state.card);
  state.data.meta = state.data.meta || {};
  state.data.meta.list = state.list;
  renderRows();
}
$('#addRowBtn').onclick = addRow;
$('#reloadBtn').onclick = loadCurrent;
$('#downloadBtn').onclick = ()=>{
  const fn = pathFor().replace('/data/','').replace(/\//g,'__');
  download(fn, JSON.stringify(state.data,null,2));
};
$('#commitBtn').onclick = ()=>{ $('#ghBox').style.display='block'; };
$('#doCommitBtn').onclick = doCommit;

async function doCommit(){
  const owner = $('#ghOwner').value.trim();
  const repo  = $('#ghRepo').value.trim();
  const branch= $('#ghBranch').value.trim();
  const token = $('#ghToken').value.trim();
  const path  = pathFor().replace(/^\//,''); // data/...
  const msgEl = $('#ghMsg'); msgEl.textContent='커밋 중…';

  const headers = { 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' };

  // sha 조회(있으면 update, 없으면 create)
  let sha = null;
  const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${branch}`;
  const getRes = await fetch(getUrl, {headers});
  if(getRes.status===200){ const j=await getRes.json(); sha=j.sha; }

  const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: `chore: update ${path}`,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(state.data,null,2)))),
    branch
  };
  if(sha) body.sha = sha;

  const putRes = await fetch(putUrl, {method:'PUT', headers, body: JSON.stringify(body)});
  if(putRes.status>=200 && putRes.status<300){ msgEl.textContent='성공! 레포에 커밋되었습니다.'; }
  else{ const t = await putRes.text(); msgEl.textContent='실패: '+t; }
}

/* ------------------------- 그룹 추가/탭 전환 ------------------------- */
$('#addListBtn').onclick = ()=>{
  const name = $('#newListName').value.trim();
  if(!name) return alert('그룹 이름을 입력하세요. 예) default, bible30, poem');
  if(!state.lists[state.card]) state.lists[state.card] = [];
  if(!state.lists[state.card].includes(name)) state.lists[state.card].push(name);
  state.list = name; $('#newListName').value='';
  renderListTabs(); syncPath(); state.data = skeleton(state.card); renderHeader(); renderRows();
};

/* 프리셋: 힐링 전용 */
$('#presetBox').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-preset]'); if(!btn) return;
  const code = btn.dataset.preset;
  let name = prompt(`새 그룹 이름을 입력하세요 (예: healing-a, bible30, poem)`, code==='A'?'healing-a': code==='B'?'bible30':'poem');
  if(!name) return;
  if(!state.lists.healing.includes(name)) state.lists.healing.push(name);
  state.card = 'healing'; state.list = name; renderCardTabs(); renderListTabs(); togglePresetBox(); syncPath();
  // 템플릿 데이터 주입
  if(code==='A'){ // 힐링메세지
    state.data = { meta:{list:name,lang:'ko',credit:'출처 표기'}, items:[
      {id:newId('HLG'), text:'당신의 오늘이 따뜻하길', tags:['위로'], weight:1, status:'APPROVED'},
      {id:newId('HLG'), text:'괜찮아, 여기까지 잘 왔어', tags:['격려'], weight:1, status:'DRAFT'}
    ]};
  }else if(code==='B'){ // 성구30
    state.data = { meta:{list:name,lang:'ko',credit:'성경: 개역개정'}, items:[
      {id:'BJ-016', text:'주는 그리스도시요 살아계신 하나님의 아들이시니이다. (마16:16)', tags:['성경'], weight:1, status:'APPROVED'},
      {id:'PS-023', text:'여호와는 나의 목자시니 내게 부족함이 없으리로다. (시23:1)', tags:['성경'], weight:1, status:'APPROVED'}
    ]};
  }else{ // C 시(詩)
    state.data = { meta:{list:name,lang:'ko',credit:'시 출처 표기'}, items:[
      {id:newId('POEM'), text:'나 보기가 역겨워 가실 때에는(— 김소월 「진달래꽃」)', tags:['시'], weight:1, status:'DRAFT'}
    ]};
  }
  renderHeader(); renderRows();
});

/* 목록 새로고침: GitHub 탐색 */
async function refreshLists(){
  const lists = await ghListJsonFiles(state.card);
  if(lists && lists.length){ state.lists[state.card] = lists; }
  else if(!state.lists[state.card]?.length){
    // fallback
    state.lists[state.card] = state.card==='healing' ? ['bible30'] : ['default'];
  }
  renderListTabs();
}

/* ------------------------- 초기화 ------------------------- */
async function boot(){
  renderCardTabs();
  togglePresetBox();
  await refreshLists();       // 초기 카드: hanlove
  state.list = state.lists[state.card][0] || 'default';
  renderListTabs();
  syncPath();
  loadCurrent();
}
$('#refreshListsBtn').onclick = refreshLists;
boot();
</script>
